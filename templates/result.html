<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NutriDash - Analysis Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Inherit Theme Variables */
        :root {
            --bg-color: #f4f6f9;
            --text-color: #333;
            --card-bg: #ffffff;
            --primary-color: #1abc9c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }

        body.dark {
            --bg-color: #121212;
            --text-color: #f1f1f1;
            --card-bg: #1e1e1e;
            --primary-color: #2ecc71;
            --success-color: #00b894;
            --warning-color: #ffc107;
            --danger-color: #c0392b;
            --info-color: #5dade2;
        }

        body { 
            background: var(--bg-color); 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            margin: 0; 
            color: var(--text-color);
            transition: all 0.5s ease;
        }
        .container { margin-top: 50px; margin-bottom: 50px; }
        .card { 
            background-color: var(--card-bg);
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            border: none;
            color: var(--text-color);
        }
        h2 { color: var(--primary-color); }

        /* Score Box Styling */
        .score-box { 
            font-size: 2.5rem; 
            font-weight: bold; 
            padding: 25px; 
            border-radius: 10px; 
            text-align: center; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .healthy { background-color: color-mix(in srgb, var(--success-color) 20%, transparent); color: var(--success-color); border: 1px solid var(--success-color);}
        .moderate { background-color: color-mix(in srgb, var(--warning-color) 20%, transparent); color: var(--warning-color); border: 1px solid var(--warning-color);}
        .unhealthy, .error { 
            background-color: color-mix(in srgb, var(--danger-color) 20%, transparent); 
            color: var(--danger-color); 
            border: 1px solid var(--danger-color);
        }

        /* NEW: Risk Box Styling */
        .risk-box {
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            text-transform: uppercase;
        }
        .risk-low { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .risk-medium { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .risk-high, .risk-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .list-group-item {
            background-color: transparent;
            color: var(--text-color);
            border-color: color-mix(in srgb, var(--text-color) 10%, transparent);
        }
        pre {
            background-color: color-mix(in srgb, var(--text-color) 5%, transparent);
            border: 1px solid #ddd;
            color: var(--text-color);
            overflow-x: auto;
        }
        .flagged-item-high { color: var(--danger-color); font-weight: bold; }
        .flagged-item-medium { color: var(--warning-color); }
        .flagged-item-low { color: var(--success-color); }
    </style>
</head>
<body class="{{ 'dark' if session.get('theme') == 'dark' else 'light' }}">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h2 class="text-center mb-4"><i class="fas fa-microscope"></i> Analysis Complete</h2>

                <div class="card p-4 mb-4">
                    <div class="row">
                        <div class="col-md-5 text-center">
                            <h4>Original Label</h4>
                            <img src="{{ url_for('static', filename='uploads/' + image) }}" class="img-fluid rounded shadow-sm" alt="Uploaded Nutrition Label" style="max-height: 250px; object-fit: contain;">
                            <small class="text-muted d-block mt-2">Image analysis source</small>
                        </div>
                        
                        <div class="col-md-7">
                            <h4 class="mb-3">Health Score (Macro-based)</h4>
                            
                            {% set is_error = result.level == 'Error ❌' %}
                            {% set score_class = 'error' if is_error else ('healthy' if result.score >= 70 else ('moderate' if result.score >= 40 else 'unhealthy')) %}
                            
                            <div class="score-box {{ score_class }}">
                                {% if is_error %}
                                    <i class="fas fa-exclamation-triangle"></i> N/A
                                {% else %}
                                    {{ result.score }} / 100
                                {% endif %}
                                <span class="d-block fs-5 mt-2">{{ result.level }}</span>
                            </div>

                            <h4 class="mt-4 mb-3">Ingredient Risk Analysis</h4>
                            
                            {% set risk_class = 'risk-error' %}
                            {% if result.risk_score|lower == 'low' %}
                                {% set risk_class = 'risk-low' %}
                            {% elif result.risk_score|lower == 'medium' %}
                                {% set risk_class = 'risk-medium' %}
                            {% elif result.risk_score|lower == 'high' %}
                                {% set risk_class = 'risk-high' %}
                            {% endif %}

                            <div class="risk-box {{ risk_class }}">
                                Overall Risk: {{ result.risk_score or 'N/A' }}
                            </div>
                            </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h4 class="mb-3">Extracted Nutritional Breakdown</h4>
                            {% if is_error %}
                                <p class="alert alert-danger">Cannot display breakdown. See the raw text below for the specific error message.</p>
                            {% else %}
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Energy (kcal):
                                        <span class="badge bg-primary rounded-pill">{{ result.Energy }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Protein (g):
                                        <span class="badge bg-success rounded-pill">{{ result.Protein }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Total Fat (g):
                                        <span class="badge bg-danger rounded-pill">{{ result.Total_Fat }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Sugars (g):
                                        <span class="badge bg-warning text-dark rounded-pill">{{ result.Sugars }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Total Carbohydrates (g):
                                        <span class="badge bg-info rounded-pill">{{ result.Total_Carbohydrates }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Dietary Fiber (g):
                                        <span class="badge bg-secondary rounded-pill">{{ result.Dietary_Fiber }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Sodium (mg):
                                        <span class="badge bg-dark rounded-pill">{{ result.Sodium }}</span>
                                    </li>
                                </ul>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h4 class="mb-3">Flagged Ingredients</h4>
                            <ul class="list-group list-group-flush">
                                {% if result.ingredients_risk and result.ingredients_risk|length > 0 %}
                                    {% for item in result.ingredients_risk %}
                                        <li class="list-group-item">
                                            {% set tag_class = 'flagged-item-low' %}
                                            {% if 'Risk' in item %}
                                                {% set tag_class = 'flagged-item-high' %}
                                            {% elif 'Benefit' in item %}
                                                {% set tag_class = 'flagged-item-low' %}
                                            {% endif %}
                                            <span class="{{ tag_class }}">{{ item }}</span>
                                        </li>
                                    {% endfor %}
                                {% else %}
                                    <li class="list-group-item text-muted small">No flagged ingredients found, or analysis was skipped.</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                </div>

                <div class="card p-4">
                    <h4>AI Suggestion & Analysis Details</h4>

                    {% if suggestion.startswith("FATAL OCR ERROR:") %}
                        <p class="text-danger fw-bold"><i class="fas fa-bug"></i> {{ suggestion }}</p>
                        <pre class="p-3 rounded border bg-light text-muted">
                            Analysis failed. Check Tesseract installation and path.
                        </pre>
                    {% else %}
                        <pre class="p-3 rounded border">{{ suggestion }}</pre>
                    {% endif %}
                </div>

                <div class="mt-4 text-center">
                    <a href="{{ url_for('food_analysis') }}" class="btn btn-info me-2"><i class="fas fa-redo"></i> Analyze Another Label</a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary"><i class="fas fa-home"></i> Go to Dashboard</a>
                </div>

            </div>
        </div>
    </div>
</body>
</html>