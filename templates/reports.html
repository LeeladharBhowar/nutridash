<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NutriDash - Reports & Trends</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles copied from other pages */
        body { background: #f4f6f9; font-family: "Segoe UI", Tahoma, sans-serif; margin: 0; display: flex; transition: all 0.3s ease; }
        .sidebar {
            width: 230px; height: 100vh; position: fixed; left: 0; top: 0;
            background: linear-gradient(180deg, #2c3e50, #34495e); color: white; padding-top: 20px; box-shadow: 3px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar h3 { text-align: center; margin-bottom: 30px; font-size: 22px; letter-spacing: 1px;}
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar ul li { margin: 15px 0; }
        .sidebar ul li a {
            color: white; text-decoration: none; font-size: 16px; display: flex;
            align-items: center; padding: 10px 20px; transition: all 0.3s ease; border-radius: 8px;
        }
        .sidebar ul li a i { margin-right: 10px; }
        .sidebar ul li a:hover, .sidebar ul li a.active { background: #1abc9c; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
        .sidebar .logout { margin-top: 30px; text-align: center; display: block; color: #f8d7da; font-weight: bold;}
        .content { margin-left: 230px; padding: 30px; flex: 1; }
        h2 { margin-bottom: 30px; color: #2c3e50; font-weight: 700; }
        
        /* Reports Specific Styles */
        .report-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .nav-link.active {
            background-color: #1abc9c !important;
            color: white !important;
            font-weight: 600;
        }
        .chart-container {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }

        /* NEW: Goal Suggestion Card Styles (Advanced Visual) */
        #goalSuggestionCard {
            background-color: #e8f5e9;
            border-left: 5px solid #28a745;
            margin-bottom: 30px;
        }
        .goal-macro-box {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            /* Added margin-x to reduce crowding */
            margin-right: 10px; 
            margin-left: 10px;
        }
        .goal-macro-box h5 {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 0;
        }
        .goal-macro-box p {
            color: #1abc9c;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
        }

    </style>
</head>
<body onload="loadReportData('daily'); fetchGoalSuggestion()">

<div class="sidebar">
    <h3><i class="fas fa-leaf"></i> NutriDash</h3>
    <ul>
        <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="{{ url_for('food_analysis') }}"><i class="fas fa-apple-alt"></i> Food Analysis</a></li>
        <li><a href="{{ url_for('reports') }}" class="active"><i class="fas fa-chart-bar"></i> Reports</a></li>
        <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Settings</a></li>
        <li><a href="{{ url_for('tracker') }}"><i class="fas fa-utensils"></i> Tracker</a></li>
        <li><a href="{{ url_for('logout') }}" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
</div>

<div class="content">
    <h2>ðŸ“ˆ Historical Nutrition Reports</h2>

    <div id="goalSuggestionCard" class="report-card p-4">
        <h4 class="mb-3"><i class="fas fa-bullseye me-2"></i> Your Personalized Daily Targets</h4>
        <div id="goalOutput">
            <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Fetching targets based on your goal...</p>
        </div>
    </div>
    <div class="report-card">
        <h4 class="mb-4 text-primary">Macro Trends Over Time</h4>
        
        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="true" onclick="loadReportData('daily')">7-Day View</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="false" onclick="loadReportData('monthly')">30-Day View</button>
            </li>
        </ul>

        <div class="tab-content" id="reportTabsContent">
            
            <div class="tab-pane fade show active" id="daily" role="tabpanel" aria-labelledby="daily-tab">
                <div class="chart-container">
                    <canvas id="macroChartDaily"></canvas>
                </div>
            </div>

            <div class="tab-pane fade" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
                <div class="chart-container">
                    <canvas id="macroChartMonthly"></canvas>
                </div>
            </div>
            
        </div>
        
        <p class="text-muted small mt-4">Note: Data visualization requires actual historical logs saved via the Tracker page.</p>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Access the current username from the Jinja context passed by Flask
    const CURRENT_USER = "{{ username }}"; 

    // Hardcoded Mock Data (This would be fetched from Flask via /api/reports/daily or similar)
    const MOCK_REPORT_DATA = {
        'daily': {
            labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
            protein: [85, 92, 105, 78, 110, 95, 120],
            calories: [2100, 2050, 2300, 1900, 2450, 2150, 2500],
            fat: [60, 55, 75, 50, 80, 65, 70],
        },
        'monthly': {
            labels: ['Wk 1', 'Wk 2', 'Wk 3', 'Wk 4'],
            protein: [95, 100, 98, 105],
            calories: [2150, 2200, 2100, 2300],
            fat: [65, 70, 60, 72],
        }
    };

    let dailyChart = null;
    let monthlyChart = null;

    /**
     * Fetches personalized macro goals from the Flask API (using the same endpoint as Profile).
     * @returns {Promise<void>}
     */
    async function fetchGoalSuggestion() {
        const goalOutputDiv = document.getElementById('goalOutput');

        try {
            // Your Flask API route for calculated goals
            const response = await fetch("{{ url_for('get_user_goals', username=username) }}");
            
            if (!response.ok) {
                // Throw error if not found, forcing the catch block to display the error state
                throw new Error("Could not fetch personalized goals. Status: " + response.status);
            }
            
            const data = await response.json();
            
            // --- Gemini/Goal Display ---
            // Note: The /api/goals route provides calculated targets based on weight/goal.
            // The template uses these calculated targets directly.
            const goalText = `Based on your goal to **${data.goal}** and current weight (${data.weight} kg), your recommended daily intake is:`;
            
            const macroBoxes = `
                <div class="row justify-content-center mt-3">
                    <div class="col-md-3 goal-macro-box">
                        <h5>Calories</h5>
                        <p>${data.target_calories.toLocaleString()} kcal</p>
                    </div>
                    <div class="col-md-3 goal-macro-box">
                        <h5>Protein</h5>
                        <p>${data.target_protein.toFixed(0)} g</p>
                    </div>
                    <div class="col-md-3 goal-macro-box">
                        <h5>Carbs</h5>
                        <p>${data.target_carbs.toFixed(0)} g</p>
                    </div>
                </div>
                <p class="text-muted small mt-3 text-center">Recommended Fat Intake: ${data.target_fat.toFixed(0)} g (approx. 25% of calories).</p>
            `;

            goalOutputDiv.innerHTML = `
                <p class="fw-bold">${goalText}</p>
                ${macroBoxes}
            `;

        } catch (error) {
            console.error("Error loading personalized plan:", error);
            goalOutputDiv.innerHTML = `
                <p class="text-danger fw-bold">Error loading personalized plan.</p>
                <p class="text-muted small">Please ensure your weight and health goal are set in the <a href="{{ url_for('settings') }}">Settings</a> page.</p>
            `;
        }
    }


    /**
     * Initializes or updates the Chart.js visualization.
     * @param {string} period - 'daily' or 'monthly'.
     */
    function loadReportData(period) {
        const data = MOCK_REPORT_DATA[period];
        const canvasId = `macroChart${period === 'daily' ? 'Daily' : 'Monthly'}`;
        const ctx = document.getElementById(canvasId).getContext('2d');

        // Destroy previous chart instance before creating a new one
        if (period === 'daily' && dailyChart) { dailyChart.destroy(); }
        if (period === 'monthly' && monthlyChart) { monthlyChart.destroy(); }

        const newChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Protein (g)',
                        data: data.protein,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Calories (kcal)',
                        data: data.calories,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        fill: false,
                        yAxisID: 'y1', 
                        tension: 0.3
                    },
                    {
                        label: 'Fat (g)',
                        data: data.fat,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.2)',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `${period === 'daily' ? 'Last 7 Days' : 'Last 4 Weeks'} Nutrition Trend`,
                        font: { size: 16 }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Grams (g)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Calories (kcal)' },
                        grid: { drawOnChartArea: false } 
                    }
                }
            }
        });

        // Store chart instance
        if (period === 'daily') { dailyChart = newChart; }
        if (period === 'monthly') { monthlyChart = newChart; }
    }
</script>
</body>
</html>