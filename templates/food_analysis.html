<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NutriDash Tracker Pro</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { background: hwb(210 63% 4%); font-family: "Segoe UI", Tahoma, sans-serif; margin: 0; display: flex; }
  /* Sidebar */
  .sidebar {
    width: 230px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    background: linear-gradient(180deg, #2c3e50, #34495e);
    color: white;
    padding-top: 20px;
  }
  .sidebar h3 { text-align:center; margin-bottom:30px; font-size:22px; }
  .sidebar ul { list-style:none; padding:0; }
  .sidebar ul li { margin:15px 0; }
  .sidebar ul li a { color:white; text-decoration:none; font-size:16px; display:flex; align-items:center; padding:10px 20px; transition: background 0.3s; border-radius:8px; }
  .sidebar ul li a i { margin-right:10px; }
  .sidebar ul li a:hover, .sidebar ul li a.active { background:#1abc9c; }
  .sidebar .logout { margin-top:30px; text-align:center; display:block; color:#f8d7da; }
  /* Content */
  .content { margin-left:230px; padding:30px; flex:1; }
  h2 { color: #fff; font-weight: 600; margin-bottom: 2rem; text-align:center; }
  .card { border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 1.5rem; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
  #labelPreview { border: 2px dashed #ccc; padding: 5px; transition: transform 0.2s; max-height:200px; margin-top:10px; }
  #labelPreview:hover { transform: scale(1.02); }
  .health-green { color: #28a745; font-weight: bold; background-color: #e6f4ea; padding: 6px 12px; border-radius: 12px; display: inline-block; }
  .health-orange { color: #fd7e14; font-weight: bold; background-color: #fff4e6; padding: 6px 12px; border-radius: 12px; display: inline-block; }
  .health-red { color: #dc3545; font-weight: bold; background-color: #f8d7da; padding: 6px 12px; border-radius: 12px; display: inline-block; }
  .btn-warning { background-color: #ffb600; border: none; font-weight: 500; transition: background-color 0.2s; }
  .btn-warning:hover { background-color: #ffa500; }
  #nutritionSummary li { font-size: 1rem; padding: 6px 0; list-style:none; }
  .progress { height: 20px; border-radius: 12px; margin-bottom: 10px; }
  @media (max-width: 576px) { #labelPreview { max-height: 150px; } }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h3><i class="fas fa-leaf"></i> NutriDash</h3>
  <ul>
    <li><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
    <li><a href="/food-analysis" class="active"><i class="fas fa-apple-alt"></i> Food Analysis</a></li>
    <li><a href="/reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
    <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
    <li><a href="/tracker"><i class="fas fa-utensils"></i> Tracker</a></li>
    <li><a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
  </ul>
</div>

<div class="content">
  <h2>NutriDash Tracker Pro üçè</h2>

  <!-- Upload Section -->
  <div class="card p-3">
    <h5>Upload Nutrition Label</h5>
    <input type="file" class="form-control" id="labelImage" accept="image/*">
    <img id="labelPreview" class="img-fluid rounded" style="display:none;">
    <button class="btn btn-warning mt-2" onclick="analyzeLabelOCR()">Analyze Label</button>
    <button class="btn btn-success mt-2" onclick="exportPDF()">Export Summary PDF</button>
  </div>

  <!-- Nutrition Summary -->
  <div class="card p-3">
    <h5>Nutrition Summary</h5>
    <ul id="nutritionSummary">
      <li>Calories: 0</li>
      <li>Protein: 0g</li>
      <li>Fat: 0g</li>
      <li>Carbs: 0g</li>
      <li>Sugars: 0g</li>
      <li>Sodium: 0mg</li>
    </ul>
  </div>

  <!-- Visual Bars -->
  <div class="card p-3">
    <h5>Nutrient Levels</h5>
    <div class="mb-2">Calories <span id="caloriesValue"></span></div>
    <div class="progress"><div id="caloriesBar" class="progress-bar bg-info" role="progressbar" style="width:0%">0%</div></div>
    <div class="mb-2">Protein <span id="proteinValue"></span></div>
    <div class="progress"><div id="proteinBar" class="progress-bar bg-success" role="progressbar" style="width:0%">0%</div></div>
    <div class="mb-2">Fat <span id="fatValue"></span></div>
    <div class="progress"><div id="fatBar" class="progress-bar bg-danger" role="progressbar" style="width:0%">0%</div></div>
    <div class="mb-2">Carbs <span id="carbsValue"></span></div>
    <div class="progress"><div id="carbsBar" class="progress-bar bg-warning" role="progressbar" style="width:0%">0%</div></div>
    <div class="mb-2">Sugars <span id="sugarValue"></span></div>
    <div class="progress"><div id="sugarBar" class="progress-bar bg-purple" role="progressbar" style="width:0%">0%</div></div>
    <div class="mb-2">Sodium <span id="sodiumValue"></span></div>
    <div class="progress"><div id="sodiumBar" class="progress-bar bg-secondary" role="progressbar" style="width:0%">0%</div></div>
  </div>

  <!-- Smart Summary -->
  <div id="labelResult" class="mt-3"></div>
</div>

<script>
let currentFacts = {};

document.getElementById("labelImage").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(evt){
      const img = document.getElementById("labelPreview");
      img.src = evt.target.result;
      img.style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

async function analyzeLabelOCR(){
  const fileInput = document.getElementById("labelImage");
  if(!fileInput.files[0]){
    alert("Please upload a nutrition label image first!");
    return;
  }
  const img = document.getElementById("labelPreview");
  document.getElementById("labelResult").innerHTML = `<p>Processing OCR, please wait...</p>`;

  const { data: { text } } = await Tesseract.recognize(img.src, 'eng', { logger: m => console.log(m) });

  const getValue = (key) => {
    const regex = new RegExp(`${key}[:\\s]*([\\d\\.]+)`, "i");
    const match = text.match(regex);
    return match ? parseFloat(match[1]) : 0;
  };

  const facts = {
    Calories: getValue("Calories"),
    Protein: getValue("Protein"),
    Fat: getValue("Fat"),
    Carbs: getValue("Carbs"),
    Sugars: getValue("Sugars"),
    Sodium: getValue("Sodium")
  };
  currentFacts = facts;

  document.getElementById("nutritionSummary").innerHTML = `
    <li>Calories: ${facts.Calories}</li>
    <li>Protein: ${facts.Protein}g</li>
    <li>Fat: ${facts.Fat}g</li>
    <li>Carbs: ${facts.Carbs}g</li>
    <li>Sugars: ${facts.Sugars}g</li>
    <li>Sodium: ${facts.Sodium}mg</li>
  `;

  const updateBar = (barId, value, max=200) => {
    const percentage = Math.min(100, (value/max)*100);
    document.getElementById(barId).style.width = percentage + "%";
    document.getElementById(barId).innerText = value;
  };
  updateBar("caloriesBar", facts.Calories, 500);
  updateBar("proteinBar", facts.Protein, 50);
  updateBar("fatBar", facts.Fat, 50);
  updateBar("carbsBar", facts.Carbs, 100);
  updateBar("sugarBar", facts.Sugars, 50);
  updateBar("sodiumBar", facts.Sodium, 500);

  let rec = "Good";
  if(facts.Fat>15 || facts.Sugars>20 || facts.Sodium>500) rec="Limit";
  else if(facts.Fat>7 || facts.Sugars>10 || facts.Sodium>200) rec="Moderate";

  let explanation = `Calories: ${facts.Calories}, Protein: ${facts.Protein}g, Fat: ${facts.Fat}g. `;
  explanation += `Sugars: ${facts.Sugars}g, Sodium: ${facts.Sodium}mg. Recommended: ${rec}.`;

  let healthClass = rec=="Good"?"health-green":rec=="Moderate"?"health-orange":"health-red";

  document.getElementById("labelResult").innerHTML = `
    <div class="card p-3 shadow-sm mt-2">
      <h5>Smart Nutrition Summary</h5>
      <p class="${healthClass}">${explanation}</p>
    </div>
  `;
}

// Export PDF
function exportPDF(){
  if(Object.keys(currentFacts).length === 0){
    alert("Please analyze a nutrition label first!");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text("NutriDash Tracker Summary", 20, 20);
  doc.setFontSize(12);
  let y = 35;
  for(const [key, value] of Object.entries(currentFacts)){
    doc.text(`${key}: ${value}`, 20, y);
    y += 10;
  }
  doc.save("Nutrition_Summary.pdf");
}
</script>

</body>
</html>
