<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NutriDash - Advanced OCR Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* -------------------------------------- */
    /* 1. Base and Sidebar Styles (Copied from Tracker) */
    /* -------------------------------------- */
    body { 
        background: hwb(208 59% 4%); 
        font-family: "Segoe UI", Tahoma, sans-serif; 
        margin: 0; 
        display: flex; 
        transition: all 0.3s ease;
    }
    .sidebar {
      width: 230px; height: 100vh; position: fixed; left: 0; top: 0;
      background: linear-gradient(180deg, #2c3e50, #34495e); color: white; padding-top: 20px; box-shadow: 3px 0 15px rgba(0,0,0,0.1);
    }
    .sidebar h3 { text-align: center; margin-bottom: 30px; font-size: 22px; letter-spacing: 1px;}
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { margin: 15px 0; }
    .sidebar ul li a {
      color: white; text-decoration: none; font-size: 16px; display: flex;
      align-items: center; padding: 10px 20px; transition: all 0.3s ease; border-radius: 8px;
    }
    .sidebar ul li a i { margin-right: 10px; }
    .sidebar ul li a:hover, .sidebar ul li a.active { background: #1abc9c; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
    .sidebar .logout { margin-top: 30px; text-align: center; display: block; color: #f8d7da; font-weight: bold;}

    /* -------------------------------------- */
    /* 2. Content and Card Styles */
    /* -------------------------------------- */
    .content { margin-left: 230px; padding: 30px; flex: 1; }
    h2 { margin-bottom: 30px; color: #2c3e50; }
    .btn-primary { background-color: #1abc9c; border-color: #1abc9c; transition: background-color 0.2s; }
    .btn-primary:hover { background-color: #16a085; border-color: #16a085; }

    /* ADVANCED Layout */
    .analysis-grid {
        display: flex;
        gap: 25px;
    }
    .upload-card, .results-card {
        background-color: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .upload-card {
        flex: 1; /* Takes primary upload space */
        min-width: 350px;
    }
    .results-card {
        flex: 2; /* Takes more space for results */
        min-width: 500px;
    }

    /* Image Preview */
    #imagePreview {
        max-width: 100%;
        max-height: 250px;
        width: auto;
        height: auto;
        display: block;
        margin: 15px auto;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: 2px dashed #ddd;
        object-fit: contain;
    }

    /* Result Section Styling (To mimic AI output) */
    .result-section h4 {
        color: #34495e;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-top: 20px;
        font-weight: 600;
    }
    .verdict-box {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2em;
        transition: all 0.3s ease;
    }
    .verdict-Excellent, .verdict-Good { background-color: #d4edda; color: #155724; }
    .verdict-Caution, .verdict-Okay { background-color: #fff3cd; color: #856404; }
    .verdict-Poor, .verdict-Bad, .verdict-Error { background-color: #f8d7da; color: #721c24; }

    /* Ingredients List Styling */
    .ingredients-list {
        list-style: none;
        padding-left: 0;
    }
    .ingredients-list li {
        margin-bottom: 5px;
        padding: 5px;
        border-bottom: 1px dotted #eee;
    }


    /* Media Queries for Responsiveness */
    @media (max-width: 1000px) {
        .analysis-grid {
            flex-direction: column;
        }
    }
    @media (max-width: 768px) {
        .sidebar { width: 100%; height: auto; position: relative; }
        .content { margin-left: 0; padding: 20px; }
        .upload-card, .results-card { min-width: auto; }
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h3><i class="fas fa-leaf"></i> NutriDash</h3>
  <ul>
    <li><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
    <li><a href="/food-analysis" class="active"><i class="fas fa-apple-alt"></i> Food Analysis</a></li>
    <li><a href="/reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
    <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
    <li><a href="/tracker"><i class="fas fa-utensils"></i> Tracker</a></li>
    <li><a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
  </ul>
</div>
<div class="content">
    <h2>📸 Food Label AI Analysis (OCR)</h2>
    <p class="text-muted">Use multimodal AI to extract nutrition facts and ingredients directly from a label image for instant analysis and risk assessment.</p>

    <div class="analysis-grid">
        
        <div class="upload-card">
            <h4>1. Upload Label & Preview</h4>
            <p class="text-muted small">Ensure the image is clear and the text is legible for accurate OCR extraction.</p>
            
            <form id="ocrForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="fileInput" class="form-label fw-bold">Select Label Image (.jpg, .png)</label>
                    <input class="form-control" type="file" id="fileInput" name="file" accept="image/*" onchange="previewImage(event)" required>
                </div>
                
                <img id="imagePreview" src="#" alt="Image Preview" style="display:none;">

                <button type="submit" class="btn btn-primary w-100 mt-3" onclick="analyzeLabel(event)"><i class="fas fa-camera"></i> Run AI Analysis</button>
            </form>
        </div>

        <div class="results-card">
            <h4>2. Analysis Results & Verdict</h4>
            
            <div id="loadingStatus" class="alert alert-info text-center" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Analyzing image, please wait...
            </div>

            <div id="analysisResults" class="result-section">
                
                <p class="text-muted text-center mt-4" id="initialMessage">Upload an image to see the extracted data, nutritional summary, and health verdict here.</p>
                
                <div id="dynamicContent" style="display: none;">
                    <div class="row mt-4">
                        <div class="col-md-5">
                            <h5 class="fw-bold">AI Verdict:</h5>
                            <div id="verdictBox" class="verdict-box verdict-caution">Loading...</div>
                        </div>
                        <div class="col-md-7">
                            <h5 class="fw-bold">AI Suggestion:</h5>
                            <p id="suggestionText" class="mb-0 small text-muted">Analyzing the overall profile...</p>
                        </div>
                    </div>

                    <h4 class="mt-4">Extracted Nutrients:</h4>
                    <ul id="nutritionList" class="list-group list-group-flush small">
                        </ul>
                    
                    <h4 class="mt-4">Ingredients of Concern/Benefit:</h4>
                    <ul id="ingredientsList" class="ingredients-list small">
                         </ul>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // Mock JSON response (Your provided data)
    const MOCK_API_RESPONSE = {
        "ingredients_of_concern": [
            "Whole Oats (Excellent)",
            "High Fructose Corn Syrup (Caution)",
            "Soy Lecithin"
        ],
        "nutrition_summary": {
            "Calories": "300 kcal",
            "Protein": "8g",
            "Saturated Fat": "3g",
            "Sodium": "180mg",
            "Sugar": "15g"
        },
        "suggestion": "The overall profile is good, but the **High Fructose Corn Syrup** is a concern. Enjoy in moderation and check serving size!",
        "verdict": "Good"
    };

    // Function to display the uploaded image immediately
    function previewImage(event) {
        const preview = document.getElementById('imagePreview');
        if (event.target.files && event.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                preview.alt = "Uploaded Food Label";
                document.getElementById('initialMessage').style.display = 'none';
            }
            reader.readAsDataURL(event.target.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }
    
    // Function to set the correct verdict color class
    function getVerdictClass(verdict) {
        const lowerVerdict = verdict.toLowerCase();
        if (lowerVerdict.includes('excellent') || lowerVerdict.includes('good')) {
            return 'verdict-Good';
        } else if (lowerVerdict.includes('caution') || lowerVerdict.includes('okay')) {
            return 'verdict-Caution';
        } else {
            return 'verdict-Poor';
        }
    }

    /**
     * ADVANCED FUNCTION: Handles form submission, shows loading, and fetches/displays structured AI results.
     */
    async function analyzeLabel(event) {
        event.preventDefault(); 
        
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) return;

        const loadingStatus = document.getElementById('loadingStatus');
        const dynamicContent = document.getElementById('dynamicContent');
        
        // 1. Show Loading Status
        loadingStatus.style.display = 'block';
        dynamicContent.style.display = 'none';
        document.getElementById('initialMessage').style.display = 'none';

        // 2. Perform Fetch/Mock API Call
        // In a real app, you would use FormData and fetch to the Flask /analyze endpoint.
        // const formData = new FormData(document.getElementById('ocrForm'));
        
        try {
            // Mock API response delay for realistic loading effect (3 seconds)
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Assume the Flask API returns the structured JSON response
            const data = MOCK_API_RESPONSE; // Use mock data here

            // 3. Populate Results
            
            // Verdict
            const verdictBox = document.getElementById('verdictBox');
            verdictBox.textContent = data.verdict;
            verdictBox.className = 'verdict-box ' + getVerdictClass(data.verdict);

            // Suggestion
            document.getElementById('suggestionText').innerHTML = data.suggestion;

            // Nutrition Summary
            const nutritionList = document.getElementById('nutritionList');
            nutritionList.innerHTML = ''; // Clear previous list
            for (const [key, value] of Object.entries(data.nutrition_summary)) {
                nutritionList.innerHTML += `<li class="list-group-item"><strong>${key}:</strong> <span>${value}</span></li>`;
            }

            // Ingredients of Concern/Benefit
            const ingredientsList = document.getElementById('ingredientsList');
            ingredientsList.innerHTML = ''; // Clear previous list
            data.ingredients_of_concern.forEach(item => {
                let colorClass = '';
                if (item.includes('(Excellent)')) {
                    colorClass = 'text-success';
                } else if (item.includes('(Caution)')) {
                    colorClass = 'text-warning';
                }
                ingredientsList.innerHTML += `<li class="${colorClass}"><i class="fas fa-check-circle"></i> ${item}</li>`;
            });


            // 4. Hide Loading and Show Dynamic Content
            loadingStatus.style.display = 'none';
            dynamicContent.style.display = 'block';

        } catch (error) {
            console.error("Analysis failed:", error);
            loadingStatus.style.display = 'none';
            document.getElementById('initialMessage').style.display = 'block';
            document.getElementById('initialMessage').innerHTML = `<p class="text-danger">❌ **Analysis Error:** Could not process the label. Please ensure the image is clear.</p>`;
        }
    }
</script>

</body>
</html>