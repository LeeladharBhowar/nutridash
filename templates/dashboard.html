<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NutriDash - Ultimate Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Global & Sidebar Styles */
        body { 
            background: #f8f9fa; 
            font-family: "Segoe UI", Tahoma, sans-serif; 
            margin: 0; 
            display: flex; 
            transition: all 0.3s ease;
        }
        .sidebar { 
            width: 230px; 
            height: 100vh; 
            position: fixed; 
            left: 0; 
            top: 0; 
            background: linear-gradient(180deg, #2c3e50, #34495e); 
            color: white; 
            padding-top: 20px;
            box-shadow: 3px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .sidebar h3 { text-align: center; margin-bottom: 30px; font-size: 22px; letter-spacing: 1px; }
        .sidebar ul { list-style: none; padding: 0; }
        .sidebar ul li { margin: 15px 0; }
        .sidebar ul li a { 
            color: white; 
            text-decoration: none; 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            padding: 10px 20px; 
            transition: background 0.3s; 
            border-radius: 8px; 
        }
        .sidebar ul li a i { margin-right: 10px; }
        .sidebar ul li a:hover, .sidebar ul li a.active { background: #1abc9c; box-shadow: 0 0 8px rgba(0,0,0,0.3); }
        .sidebar .logout { margin-top: 30px; text-align: center; display: block; color: #f8d7da; font-weight: bold; }

        /* Main Content Layout */
        .content { 
            margin-left: 230px; 
            padding: 30px; 
            flex: 1; 
            position: relative; 
        }
        h2 { color: #2c3e50; font-weight: 700; }
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transition: transform 0.2s ease-in-out; 
        }
        .card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
        }
        
        /* ADVANCED CONTROL BAR */
        .control-bar {
            background-color: #ffffff;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* TARGET TABLE & DIET PLAN STYLING */
        #userTargetTable {
            border: 2px solid #3498db;
            margin-bottom: 25px;
            background-color: #f0f7ff;
            display: block;
        }
        #targetTableOutput {
            padding: 15px;
        }
        .macro-target-box {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .macro-target-box h6 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 1em;
        }
        .macro-target-box p {
            color: #1abc9c;
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 0;
        }


        #dietPlanCard {
            background-color: #f7f9fa; 
            border-left: 5px solid #1abc9c;
            margin-bottom: 30px;
            padding: 25px;
        }
        .meal-plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .meal-plan-item {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            border: 1px solid #eee;
        }
        .meal-plan-item strong {
            color: #2c3e50;
            display: block;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .macro-tag {
            display: inline-block;
            font-size: 0.8em;
            padding: 3px 8px;
            margin-right: 5px;
            border-radius: 4px;
            font-weight: 600;
        }
        .tag-protein { background-color: #d4edda; color: #155724; }
        .tag-carb { background-color: #fff3cd; color: #856404; }
        .tag-fat { background-color: #f8d7da; color: #721c24; }


        /* Food Card Styling */
        .nutrition-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; 
        }
        .food-card { height: 220px; display: flex; flex-direction: column; background-color: white; cursor: pointer; }
        .food-image-wrapper { height: 120px; width: 100%; overflow: hidden; border-bottom: 1px solid #eee; }
        .food-image { width: 100%; height: 100%; background-size: cover; background-position: center; transition: transform 0.5s ease; }
        .food-card:hover .food-image { transform: scale(1.05); }

        .food-card.recommended { box-shadow: 0 0 15px 3px #1abc9c; border: 3px solid #1abc9c; transform: none; }
        .food-card.recommended .food-info { background-color: #e6fff7; }

        .food-card.healthy { border: 2px solid #2ecc71; }
        .food-card.junk { border: 2px solid #e74c3c; }
        .food-card.dairy { border: 2px solid #f1c40f; }
        .food-card.frozen { border: 2px solid #3498db; }
        
        .food-info { padding: 10px; flex-grow: 1; }

        /* PROFILE STYLING (For Top Right Icon) */
        .profile-area { position: absolute; top: 30px; right: 30px; z-index: 10; }
        .profile-icon {
            width: 45px; height: 45px; border-radius: 50%; background-color: #1abc9c; 
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: 1.2em; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .profile-icon:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .profile-area .dropdown-menu { border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border: none; min-width: 180px; }
        .profile-area .dropdown-item { color: #34495e; padding: 10px 15px; transition: background-color 0.2s; }
        .profile-area .dropdown-item:hover { background-color: #e9f5f5; color: #1abc9c; }
        .profile-area .dropdown-item i { margin-right: 8px; width: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3><i class="fas fa-leaf"></i> NutriDash</h3>
        <ul>
            <li><a href="{{ url_for('dashboard') }}" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="{{ url_for('food_analysis') }}"><i class="fas fa-apple-alt"></i> Food Analysis</a></li>
            <li><a href="{{ url_for('reports') }}"><i class="fas fa-chart-bar"></i> Reports</a></li>
            <li><a href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="{{ url_for('tracker') }}"><i class="fas fa-utensils"></i> Tracker</a></li>
            <li><a href="{{ url_for('logout') }}" class="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <div class="content">

        <h2 class="mb-4">Welcome, {{ username }} üéâ</h2>
        
        <div class="profile-area dropdown">
            <div class="profile-icon" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user"></i> 
            </div>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                <li><h6 class="dropdown-header">Hello, {{ username }}!</h6></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('user_profile') }}"><i class="fas fa-id-badge"></i> My Profile</a></li>
                <li><a class="dropdown-item" href="{{ url_for('settings') }}"><i class="fas fa-cog"></i> Account Settings</a></li>
                <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
        <div class="control-bar">
            
            <div style="flex-basis: 250px;">
                <label for="weightGoal" class="form-label fw-bold text-primary mb-1">
                    <i class="fas fa-bullseye"></i> Set Your Goal
                </label>
                <select id="weightGoal" class="form-select" onchange="filterFoods(); displayDietPlan()">
                    <option value="">-- Select Goal --</option>
                    <option value="lose">Lose Weight (Calorie Deficit)</option>
                    <option value="maintain">Maintain Weight (Calorie Balance)</option>
                    <option value="gain">Gain Weight (Calorie Surplus)</option>
                </select>
            </div>

            <div style="flex-grow: 1;">
                <label for="searchName" class="form-label fw-bold text-secondary mb-1">
                    <i class="fas fa-search"></i> Search Food
                </label>
                <input type="text" id="searchName" class="form-control" placeholder="Search food name..." onkeyup="filterFoods()">
            </div>

            <div style="flex-basis: 180px;">
                <label for="filterType" class="form-label fw-bold text-secondary mb-1">
                    <i class="fas fa-filter"></i> Filter Type
                </label>
                <select id="filterType" class="form-select" onchange="filterFoods()">
                    <option value="">All Types</option>
                    <option value="healthy">Healthy ü•ó</option>
                    <option value="junk">Junk üçî</option>
                    <option value="dairy">Dairy ü•õ</option>
                    <option value="frozen">Frozen ‚ùÑÔ∏è</option>
                </select>
            </div>

        </div>
        
        <div id="userTargetTable" class="card p-4 d-none">
            <h4 class="mb-3 text-dark"><i class="fas fa-chart-bar me-2"></i> Your Estimated Daily Macro Needs</h4>
            <div id="targetTableOutput">
                <p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Fetching targets...</p>
            </div>
        </div>
        
        <div id="dietPlanCard" class="card p-4">
            <h4 class="mb-3 text-primary"><i class="fas fa-clipboard-list me-2"></i> Sample Goal-Based Diet Plan</h4>
            <div id="dietPlanOutput">
                <p class="text-muted">Select a **Weight Goal** in the control bar above to generate a sample meal plan focusing on key macros for your objective.</p>
            </div>
        </div>


        <h4 class="mb-3 mt-4 text-dark"><i class="fas fa-list-alt me-2"></i> Food Library (Recommended items are highlighted)</h4>
        <div class="nutrition-container" id="foodContainer">
            {% for food in foods %}
            {% set filename = food.name|replace(' ','_')|lower ~ '.jpg' %}
            <div class="food-card {{ food.type }}" 
                 data-calories="{{ food.calories }}" 
                 data-protein="{{ food.protein }}"
                 data-fat="{{ food.fat }}"
                 data-carbs="{{ food.carbs }}"
                 data-description="{{ food.description|escape }}"
                 data-food-name="{{ food.name|escape }}">
                
                <div class="food-image-wrapper">
                    <div class="food-image" style="background-image: url('{{ url_for('static', filename='images/' + filename) }}');">
                    </div>
                </div>

                <div class="food-info" 
                     onclick="openModal('{{ food.name|escape }}','{{ food.calories }}','{{ food.protein }}','{{ food.fat }}','{{ food.carbs }}','{{ food.description|escape }}')">
                    <strong>{{ food.name }}</strong>
                    <small>{{ food.calories }} kcal</small>
                </div>
            </div>
            {% endfor %}
            </div>
        
    </div>

    <div class="modal fade" id="foodModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4">
                <h4 id="modalName" class="text-primary mb-3"></h4>
                <p id="modalCalories" class="mb-1"></p>
                <p id="modalProtein" class="mb-1"></p>
                <p id="modalFat" class="mb-1"></p>
                <p id="modalCarbs" class="mb-3"></p>
                <p id="modalDescription" class="text-muted"></p>
                <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const CURRENT_USER = "{{ username }}"; 
    
    // --- Initial Load Sequence ---
    document.addEventListener('DOMContentLoaded', async () => {
        const goalsData = await fetchGoalsData(); 
        
        if (goalsData) {
            const goalSelect = document.getElementById('weightGoal');
            goalSelect.value = goalsData.goal.toLowerCase();

            displayTargetTable(goalsData);
        } else {
            // Placeholder data if API fails
            displayTargetTable({
                "target_calories": 2000,
                "target_protein": 80,
                "target_fat": 60,
                "target_carbs": 240,
                "goal": "MAINTAIN",
                "weight": 70
            });
        }
        
        filterFoods();
        displayDietPlan(); 
    });

    // --- API & DATA FETCHING ---
    async function fetchGoalsData() {
        try {
            // Use the API route defined in main.py
            const goalsResponse = await fetch(`{{ url_for('get_user_goals', username=username) }}`);
            
            if (!goalsResponse.ok) {
                console.error("Failed to fetch goals data.");
                return null;
            }
            return await goalsResponse.json();
        } catch (error) {
            console.error("Network error fetching goals:", error);
            return null;
        }
    }

    // --- UI/MODAL FUNCTIONS ---
    function openModal(name, calories, protein, fat, carbs, desc){
        document.getElementById('modalName').textContent = name;
        document.getElementById('modalCalories').innerHTML = `<strong>Calories:</strong> ${calories} kcal`;
        document.getElementById('modalProtein').innerHTML = `<strong>Protein:</strong> ${protein} g`;
        document.getElementById('modalFat').innerHTML = `<strong>Fat:</strong> ${fat} g`;
        document.getElementById('modalCarbs').innerHTML = `<strong>Carbs:</strong> ${carbs} g`;
        document.getElementById('modalDescription').textContent = desc;
        new bootstrap.Modal(document.getElementById('foodModal')).show();
    }

    // --- ADVANCED FEATURE: TARGET TABLE RENDERING ---
    function displayTargetTable(goalsData) {
        const outputDiv = document.getElementById('targetTableOutput');
        const card = document.getElementById('userTargetTable');
        
        if (!goalsData || !goalsData.target_calories) {
            card.classList.add('d-none');
            return;
        }
        card.classList.remove('d-none');
        
        // Use the weight and goal from the fetched data to personalize the title
        const title = `Target Macros for ${goalsData.weight.toFixed(1)} kg (${goalsData.goal})`;
        card.querySelector('h4').innerHTML = `<i class="fas fa-chart-bar me-2"></i> ${title}`;

        const targets = [
            { label: 'Total Calories', value: goalsData.target_calories, unit: 'kcal', icon: 'fire', class: 'target-cal' },
            { label: 'Protein', value: goalsData.target_protein, unit: 'g', icon: 'dumbbell', class: 'target-prot' },
            { label: 'Carbs', value: goalsData.target_carbs, unit: 'g', icon: 'bread-slice', class: 'target-carb' },
            { label: 'Fats', value: goalsData.target_fat, unit: 'g', icon: 'oil-can', class: 'target-fat' },
        ];

        let tableHtml = `<div class="row">`;
        targets.forEach(t => {
            const formattedValue = t.label === 'Total Calories' ? t.value.toLocaleString() : t.value.toFixed(0); 

            tableHtml += `
                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                    <div class="macro-target-box ${t.class}">
                        <i class="fas fa-${t.icon} me-1"></i>
                        <h6>${t.label}</h6>
                        <p>${formattedValue} ${t.unit}</p>
                    </div>
                </div>
            `;
        });
        tableHtml += `</div>`;
        
        outputDiv.innerHTML = tableHtml;
    }


    // --- ADVANCED FEATURE: SMART RECOMMENDATION LOGIC ---
    function filterFoods() {
        const nameFilter = document.getElementById('searchName').value.toLowerCase();
        const typeFilter = document.getElementById('filterType').value;
        const weightGoal = document.getElementById('weightGoal').value; 

        document.querySelectorAll('.food-card').forEach(card => {
            const cardName = card.dataset.foodName.toLowerCase();
            const cardType = card.classList.contains('healthy') ? 'healthy' : 
                             card.classList.contains('junk') ? 'junk' : 
                             card.classList.contains('dairy') ? 'dairy' : 'frozen';
            const calories = parseInt(card.dataset.calories);
            const protein = parseFloat(card.dataset.protein);
            let show = true;
            let isRecommended = false;

            // 1. Filtering Logic (Visibility)
            if (nameFilter && !cardName.includes(nameFilter)) show = false;
            if (typeFilter && cardType !== typeFilter) show = false;

            // 2. Recommendation Logic (Smart Weighting)
            card.classList.remove('recommended');

            // **NEW: Determine if the food is 'Junk' or 'High Calorie' (Calorie limit set to 500kcal for non-gain goals)**
            const isJunk = cardType === 'junk';
            const isHighCalorie = calories > 550; // A reasonable high-calorie limit for a single serving/item

            // Only proceed with recommendation logic if the item is not junk
            if (!isJunk) {
                if (weightGoal === 'lose') {
                    // Stricter for weight loss: Low Calorie, High Protein, must be Healthy or Dairy, NOT high calorie
                    if (calories <= 200 && protein >= 5 && (cardType === 'healthy' || cardType === 'dairy')) {
                        isRecommended = true;
                    } 
                } else if (weightGoal === 'maintain') {
                    // Balanced: Moderate Calorie, Good Protein, must be a healthy source, NOT high calorie
                    if (calories >= 150 && calories <= 350 && protein >= 5 && cardType !== 'junk') {
                        isRecommended = true;
                    }
                } else if (weightGoal === 'gain') {
                    // High Calorie/High Protein focus, but still *must* avoid junk for healthy gain
                    if (calories <= 300 && protein >= 10) {
                        isRecommended = true;
                    }
                }
            }
            
            // **FINAL Check: If the item is marked as Recommended, apply the class.**
            // This implicitly ensures that no 'junk' food ever gets the 'recommended' highlight.
            if (isRecommended) {
                 card.classList.add('recommended');
            }


            // 3. Apply Visibility
            card.style.display = show ? 'flex' : 'none';
        });
    }
    
    // --- ADVANCED FEATURE: DIET PLAN GENERATOR ---
    function displayDietPlan() {
        const goal = document.getElementById('weightGoal').value;
        const outputDiv = document.getElementById('dietPlanOutput');
        let planHtml = '';

        if (!goal) {
            outputDiv.innerHTML = '<p class="text-muted">Select a **Weight Goal** above to generate a sample meal plan focusing on key macros for your objective.</p>';
            return;
        }

        const plans = {
            lose: {
                focus: 'Calorie Deficit & High Protein (Avg 50-350 kcal/meal)',
                meals: [
                    { meal: 'Breakfast üç≥', focus: 'High Fiber/Protein', cal: '250-300', example: 'Oatmeal (150kcal), 2 Eggs (140kcal) & Spinach (40kcal).' },
                    { meal: 'Lunch ü•ó', focus: 'Lean Protein & Veggies', cal: '350-450', example: 'Salad (150kcal) + Grilled Chicken (250kcal) or Dal (180kcal) + Brown Rice (small portion).' },
                    { meal: 'Dinner üçΩÔ∏è', focus: 'Low Carb/Fat', cal: '300-400', example: 'Fish (200kcal) with steamed veggies, or Curd (100kcal) and Chapati (120kcal).' },
                    { meal: 'Snack üçé', focus: 'Hydration / Fiber', cal: '50-150', example: 'Apple (95kcal) or Fresh Lemon Water (40kcal).' }
                ]
            },
            maintain: {
                focus: 'Balanced Macronutrients (Avg 100-200 kcal/meal)',
                meals: [
                    { meal: 'Breakfast ü•£', focus: 'Complex Carbs & Protein', cal: '450-550', example: 'Upma (200kcal) with Paneer (100kcal) and Tea (70kcal).' },
                    { meal: 'Lunch üçõ', focus: 'Full Balanced Meal', cal: '550-650', example: 'Brown Rice (215kcal) + Dal (180kcal) + Veggie (40kcal) + Curd (100kcal).' },
                    { meal: 'Dinner üçó', focus: 'Moderate Energy', cal: '450-550', example: 'Chicken (165kcal) or Rajma (140kcal), with 2 Chapatis (240kcal).' },
                    { meal: 'Snack ü•ú', focus: 'Healthy Fats/Energy', cal: '150-250', example: 'Peanuts (160kcal) or Greek Yogurt (120kcal) with a Banana (105kcal).' }
                ]
            },
            gain: {
                focus: 'Calorie Surplus & Max Protein (Avg 150-200 kcal/meal)',
                meals: [
                    { meal: 'Breakfast üí™', focus: 'Max Calories & Protein', cal: '650-800', example: 'Poha (180kcal) + Eggs (140kcal) + Milkshake (380kcal) and Almonds (70kcal).' },
                    { meal: 'Lunch üçù', focus: 'Dense Energy Source', cal: '750-900', example: 'Large Rice (400kcal) + Soybean (170kcal) + Chicken (165kcal) or Butter Paratha (220kcal).' },
                    { meal: 'Dinner üçî', focus: 'High Protein Post-Workout', cal: '650-800', example: 'Paneer (265kcal), 2 Chapatis (240kcal), and a glass of Milk (150kcal).' },
                    { meal: 'Snack ü•õ', focus: 'Liquid Calories/Protein', cal: '250-400', example: 'Peanut Butter sandwich (approx 300kcal) with Milk (150kcal) or a handful of Nuts (200kcal).' }
                ]
            }
        };

        const currentPlan = plans[goal];
        
        planHtml += `<p class="fw-bold text-success">Goal Focus: ${currentPlan.focus}</p>`;
        planHtml += `<div class="meal-plan-grid">`;

        currentPlan.meals.forEach(item => {
            planHtml += `
                <div class="meal-plan-item">
                    <strong><i class="fas fa-seedling me-1"></i> ${item.meal}</strong>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-primary">${item.focus}</small>
                        <span class="badge text-bg-secondary">${item.cal} kcal</span>
                    </div>
                    
                    <div class="d-flex mb-2">
                        <span class="macro-tag tag-protein">P</span>
                        <span class="macro-tag tag-carb">C</span>
                        <span class="macro-tag tag-fat">F</span>
                    </div>
                    <small class="text-muted">${item.example}</small>
                </div>
            `;
        });
        
        planHtml += `</div>`;
        outputDiv.innerHTML = planHtml;
    }
</script>
</body>
</html>